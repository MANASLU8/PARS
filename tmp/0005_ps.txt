привет

ээ спасибо что пришли вечером после работы

мне очень приятно

я никогда ещё не выступал перед ээ более менее большой аудиторией так что немного волнуюсь

ээ моё пос выступление посвящено ээ но эскуэль базам

это относительно новое явление

первые но эскуэль базы появились где-то в конце двухтысячных

но на самом деле но эксуэль базы про которые все говорят это монго кассандра ээ там и тому подобное что-то

м но но эскуэль это ээ никакое не движение

это нету никакого комитета который там делает какие-то спецификации

по сути ноу эскуэль это эоо это то что не является реляционными базами данных

ээ но эскуэль ээ расшифровывается не как ээ не эксуэль а нот онли экскуэль

соответственно это не является какой-то такой заменой а обычно это должно работать ээ как реляционные так и нереляционные базы

эо мое знакомство с ноу эскуэль базами началось с хмхм на предыдущем проекте

ээ так уж получилось что я выполнял довольно много уэээ исследовательской работы по базе которая называется риак и мне в принципе это дело понравилось и я даже начал увлекаться всякими монго кассандрами и тому подобными штуками

вот собственно про монго кассандру и риак я сегодня так буду много говорить

кхм

так

когда ээ ты упоминаешь ноу эскуэль базу базы ээ люди как бы приходят в непонимание потому что у нас есть уже с семидесятых годов ээ реляционные базы данных и не совсем понятно что с ними не так и почему мы например не можем везде и всегда использовать оракл

потому что собственно эдгар кодд в семидесятом году из айбиэм он ээ предложил реляционную модель ээ данных

а в ээ ну это математика это формализм и это то что доказано им на формальной с точки зрения науки то есть ээ ну работает по идее

и сем семь в семьдесят девятом году появился оракл эо в восемьдесят втором ди би два ээ эм эс эскуэль сервер в восемьдесят девятом

самый молодой иээ май эскуэль сервер ну вот ма май эскуэль

ну соответственно он девяносто восьмого года и если так подумать то он через год уже должен или в армию пойти или ээ в институт вот ну то есть ээ тоже довольно такое зрелое решение

и мы тут ээ появляемся с какими-то ноу эскуэль базами которым от силы которым от силы там ну пять десять лет

не не совсем понятно зачем это

да кстати я з немного забыл упомянуть о формате

вы можете задавать вопросы прямо по ходу выступления

не стоит дожидаться каких-то аэ формальных частей для этого

в конце будет отведена специальная сессия если останется время ну а в принципе выступление задумано так чтобы разговаривать

до реляционных баз данных были какие-нибудь базы данных

эээ ну я так понимаю что всё что угодно можно назвать базой данных например файл можно назвать базой данных

этоааа скорее имеется в виду что были хранилища какие-то

да были

так

так вот что не так с эаа реляционными базами данных эа по-моему в шестьдесят пятом году гордон мур основатель интел он ээ выдвинул такое предположение которое потом подс ээ на протяжении нескольких десятков лет оно э подтверждалось что каждые два года количество транзисторов размещенных на одном ээ кристалле увеличивается в два раза

соответственно увеличивается и производительность и уменьшается цена всего этого оборудования

ээ потом спустя какое-то время там если шестьдесят пятый то это тридцать пять лет да примерно появились вот эти вот ээ ребята

первый предложил ээ дешевые телефоны которые нам позволили генерить сим ком всем контент

то есть у каждого у каждого из нас появилась возможность э постить котят э вот в систему которую придумал с тот чувак второй

ээ соответственно мы и все сейчас заняты тем что ну там что-то пишем что-то постим что-то такое

на самом деле конечно того что ну это как бы не рокет сайенс там запостить котёнка ээ в вконтактик но тем не менее мы все это делаем рано или гм когда или когда-либо делаем

вот

соответственно из-за этого произошло вот примерно такое

это прогноз э циско системз по росту только мобильного трафика

вот если посмотреть то там ээ в семнадцатом году ожидается восе двенадцать экзобайт трафика

аэ экзобайт если кто не знает это десять в восемнадцатой байт

это дофига

вот

и вот эти вот ээ дофига байт их как-то нужно хранить и пересылать

ну соответственно нас интересует как их хранить

ээ дело в том что все реляционные базы ну не все большинство хм реляционных баз особенно те кото с которыми у нас все ээ возникают ассоциации при слове реляционный там оракл да дэбэ два и тому подобное они были созданы немного вот до вот этого процесса когда появились ээ появились огромные массивы данных вот

если мы посмотрим на наверное самую такую известную и мощную систему оракл которая они предлагают это оракл риал аппликейшн кластер

вот здесь изображена примерно такая упрощенная архитектурка

аэ что они предлагают

ээ по сути оракл это просто процесс запущенный на какой-то машине

соответственно они предлагают ээ объединять эти машины в кластера и за счет того что у нас ээ не одна машина на базу данных а много машин мы увеличиваем ээ общий цпу общую память и соответственно общую производительность пытаемся скалировать систему

ээ как ээ видно все вот эти вот системы они все эти базы они имеют общий диск

как вы думаете для чего

у кого-нибудь есть варианты почему оракл ну и вообще реляционкам желательно иметь аэ шаринговые диски

синхронизация

ээ ну не совсем

это в принципе

общая структура

вот ээ что чт ээ за что мы все так любим реляционную модель данных

ш какие операции позволяют нам ээ легко и просто делать оракл

джоин

вот

и как вы думаете как можно сделать джойн

вот я вот подумал и придумал два способа

у нас есть все таблицы и мы делаем по ним джойн допустим ну на одном компьютере

ну да

на одном диске или там на нескольких дисках

ну неважно

нет ну смотри вот у нас здесь ээ куча машин разных и у них общий диск

и по идее что делается аа оракл вычитывает ээх данные родной таблицы фильтрует их и пытается вычитать ээ данные из другой таблицы чтобы сделать джойн

или есть ещё второй способ

кхм

второй способ заключается в том что оракл поднимает одну таблицу на од на один инстанс вторую таблицу на второй инстанс и пытается как-то по сети это всё рассинхронизовать

ну я не уверен что это на самом деле так но просто хмхм мэээ уверен что точнее уверен что делается это всё в на в памяти одной машины вот

но тем не менее если бы это было передача по сети то соответственно джойны наши они бы работали несколько дольше чем мы бы хотели

э ну за счёт там всяких передач их по сети как раз

ээ соответственно к чему на чт что нам это говорит

это говорит что аэ для того чтобы нам заиметь джойны нам нужно или смириться с тем что джойны будут медленно в случае если будет передача по сети или в том что мы будем шарить диски между разными инстансами базы данных

а так как мы шарим диски между этими инстансами разными то как раз вот дисковые операции становятся таким хорошим затыком потому что я уверен что оракл пытается распределить ээ данные таким образом чтобы было меньше коллизий чтобы было распределить ээ нагрузку более менее равномерно

но тем не менее никаких гарантий нету что один ээ что два высокона высоко ресурсоемких запроса э будут обращаться например к одному диску

соответственно это приводит к тому что ну базы не не очень хорошо справляются с большими данными и с большой нагрузкой

ну смотри репликация м реплицируется там по-моему ну н не соврать ну пусть блоки ре реплицируются в облаке в оракле самая ми минимальная единица  ааа с которой работает оракл

соответственно если у нас ааэа на каком-то на ээ один и тот же блок лежит на вот этом диске вот этом диске и на вот этом диске аэ не нету гарантий того что на этом же диске не лежит какой-нибудь блок который аэаааа к которому постоянно идет обращение

соответственно вот это вот ээ

я просто хотел показать ээ боттлнек

давайте посмотрим ээ следующий слайдик

я тут ээ ни сам самом деле не очень большое исследование проводил по ценовой политике оракла

это сайтик орашоп

первая ссылка которую я нашел ээ по в гугле оракл купить лицензию

аа собственно ва вам наверно плохо видно да давайте я вам прочитаю

собственно вот это вот поле

оракл у оракл ээ лицензионная политика такая что ты покупаешь ли ээ цена лицензии зависит от количества процессоров на котором ээ будет развернут кластер

а соответственно вот вот этот вот ээ винбоксик ээ это количество процессоров на ну в вашем кластере где нн на каком где будет работать оракл

и вам не видно но там написано тридцать два

в принципе тридцать два процессора ну там не не процессора а ядра имеется в виду тридцать два ядра это как бы э для текущих ээ систем это не очень много мягко говоря

вот

и если к оракл энтерпрайз эдишн купить риэл аппликейшн кластер то цена внизу будет почти три миллиона долларов

я просто вам хочу э рассказать что в принципе ээ большие игроки типа оракла и айбиэма требуют за свои базы ну такого приличного финансирования

вот

соответственно ну на самом деле тридцать два процессора это вообще смех

это ну на самом деле здесь не тридцать два потому что ээ там ээ сверху было написано что давайте чуваки  вы посчитаете сколько у вас процессоров по такой-то формуле

и там ээ нужно умножить количество ядер в процессоре на количество процессоров и умножить на коэффициент

а коэффициент зависит от ээ типа используемого процессора

вот я посчитал для ксенонов  и коэффициент там ноль пять

соответственно на самом деле это шестьдесят четыре процессора

и получается шестьдесят четыре на трицать два это ну шестьдесят четыре на ноль пять это тридцать два

эаа что такое шестьдесят четыре процессора это на самом деле две два сервака это два блейда по по восемь по тридцать два ядра

это ну это мало

вот

соответственно если там увеличивать до нескольких тысяч там цена тоже увеличивается на значительно

но понятно что это как бы с слабый аргумент и если вы будете реально закупать оракл под большой э кластер то там вам будут скидки тому подобное

лицензион лицензионное количество в этом случае будет пересмотрено

так

э чего предложили люди

давайте мы не будем делать ээ технологических затыков

вот то что в ээ в оракл RAC был э шаринг дисков это то что слева изображено два две базы и там ну на самом деле эта картинка немного не о том но две базы и диск посередине который они шарят

давайте мы будем использовать ээ две тачки у которых будет два локальных диска и в таком случае у нас ээ не будет затыков на инпут аутпут

ну соответственно в такой системе как мы уже обговаривали раньше скорее всего не будет работать э джойны и в большинстве ноу эскуэль баз они действительно не работают

и все проблемы ээ которые нужно ко которые решают джойны они обычно решаются через ээ денормализацию

таким изящным способом проблему джойнов мы решили

да

но соответственно джойны в больших системах они работают не очень хорошо

ну так ээ

ну смотрите мы опять-таки обсуждаем эуу обсуждаем просто объём всего этого ооу все всей этой системы

например какая-нибудь кассандра или риак у них ээ в настройках при установке можно выбрать там например ооо они рассчитаны на то чтобы работать в нескольких датацентрах одновременно

одна база у вас будет работать одновременно в нескольких датацентрах и это очень ээ такой пример из жизни что говорится

они для этого именно созданы были

то есть они и рассчитаны там на тысячи на несколько тысяч десятков тысяч ээ машин кластеры

и соответственно если мы будем строить распределенный джойн между этими машинами то это несерьёзно

аэ

кхм так аа есть ээ два таких основных э способа масштабирования систем

первый это мы просто аээ увеличиваем аа производительность каждой машин каждой отдельной машинки отдельно

соответственно мы пытаемся поднять общую производительность за счёт удорожания оборудования и в итоге э мы немного приходим в тупик потому что цена будет расти так экспоненциально немного и при этом у нас э мы всё равно упрёмся в какие-нибудь э фундаментальные такие причины типа э больше процессора например ещё круче процессора ещё нету

и что мы будем в этом случае делать

соответственно горизонтальное масштабирование это когда мы вместо того чтобы увеличивать ээ мощность одной машины мы добавляем ещё несколько машин для того чтобы аа увеличить производительность

соответственно для горизонтального масштабирования есть такие штуки как ээ репликация и шардинг данных

ну репликация это понятно

это просто мы на каждой отдельной машине э ну на нескольких ээ машинах э храним э э з зеркалированные данные

в связи с этим мы можем ээ пойти не на одну машину а сразу на две и соответственно выиграть э в производительности в два раза

шардинг это способ разбиения одной сущности одной таблицы например если мы говорим о реляционных базах на части

соответственно к чему это приводит

приводит к тому что если мы сде э разбили таблицу на три части и положили их на три разных машины то мы ходим опять-таки не на одну машину а на три разных машины и опять-таки мы немного выигрываем в производительности

так теперь несколько слов о монго

как она устроена и что там такое вообще творится

монго это довольно молодая опять-таки относительно база

в две тысячи девятом году появился первый релиз

она документно-ориентированная

там внутри хранится ну бинарное представление джейсона

аа собственно если кто не знает джейсон он слева нарисован

это аэ о вот как раз-таки джейсон является документом монго

если вы не видите то соответственно кластер монго состоит из нескольких машин на каждой машине может быть ээ крутиться несколько баз данных

ээ каждая база данных состоит из коллекции документов и соответственно документом является как раз вот этот вот джейсончик

ээ давайте и поговорим

эээ как работает эээ репликация в оракле эээ в ой в монго

в монго есть такое понятие как реплика сет

эээ один реплика сет это соответственно просто набор машин и на каждой из этих машин эээ хранятся одинаковые данные то есть одинаковые вообще не не перемешанные каким-то образом а они равноценны абсолютно

соответственно в каждом реплика сете вот если здесь посмотреть реплика сет это вот эта вот штука аааааэ в каждом реплика сете эээ есть праймэри машина и все остальные будут являться секондами

соответственно по умолчанию все запросы на запись и на чтение они идут через праймари машину

ээф оф можно ооооу делать ээ немного по-другому

можно запросы на чтение например делать со вторичных машин но это на у нас приведёт к ээ некоторой потере консистентности данных

аээ в связи с чем

потому что

вообще понятно о чём я говорю

эээ почему мы можем терять консистентность потому что данные просто не успеют скопироваться с праймари машины на вторичную машину

соответственно если мы пойдём на вторичную машину то мы не прочитаем ничего

там этих данных ещё нету

и вот такая вот штука ну они рано или поздно там появятся такая штука когда ээ данные немного неконсистентны но в т в последующем они становятся они приходят к консистентному состоянию называется ивеншуал консистенси

или если по-русски это консистентность в конечном счёте как пишут в ин в интернетах

ну идея в том что данные просто со временем становятся хорошими

смотрите

соответственно сейчас ээ выигрыша особого из-за этого нету

можно можно только риды например сделать на отдельн на с удал разрешить все риды через вторичные реплики и это приведёт к эээ снижению консистентности данных

кроме того есть режимчик когда мы выставляем ээ количество машин на которые должно записаться ээаа косо на которые должно записаться документ должен записаться документ

э соответственно если поставить ээ что например в ээ в реплика сете у нас три машины и мы говорим что на все три машины у нас должен записаться документ для того чтобы запись была признана успешной то да мы ооу у риды у нас получаются быстрыми и консистентными в итоге

ну соответственно мы начинаем проигрывать по записи потому что мы реально дожидаемся пока э данные будут срепт среплицированы на все машине ээ реплика сета

и это тоже

ну то есть здесь какой-то существует баланс между этими штуками

аэа в реплика сете все машины эа друг друга постоянно опрашивают

ээ для чего это делается

для того чтобы понять какая из машин легла

не легла ли пр праймари нода

соответственно если легла праймари нода то у нас эооооу так как запись по умолчанию делается через праймари ноду ну запись у нас не получится и чтение опять-таки не совсем получится

в этом случае у нас эээ происходит ээ голосование

выб у выбор новой праймари ноды происходит через голосование

соответственно если у нас ээ как на картинке праймари легла то праймари становится одна из ээ вторичных нод

и после того как она выбрана то у нас опять можно начинать писать на реплика сет или читать с реплика сета

соответственно в тот момент когда у нас праймари нода не существует мы все ну все операции по записи на нас на скорей всего она они у нас будут ээ зафейлены

а вот непонятно же

смотри мм праймари нода она должна выбраться наиболее ээ быстро чтобы ээ наша реплика сет заработал опять наш реплика сет заработал

а если эти секондари ноды ещё будут сравнивать

а у тебя есть этот кусок данных

а у меня есть

я победил

давай я буду

это ж будет очень долго

это нужно гонять данные или по крайней мере какие-то метаданные

смотри

мы например записали десять мегабайт час назад и один мегабайт только что

и десять мегабайт среплицировались на какую-то ноду а один мегабайт не усп а а один мегабайт среплицировался на другую ноду

соответственно победит та нода у которой если победит та нода у которой последняя пф более новая дата последней репликации то мы в итоге проиграем

так смотрите

аээ интересный случай когда у нас например было ээ пять машин в кластере да и праймари эм э сеть поделилась таким образом что праймари нода вообще легла

ааэ видят ээ друг друга только две друг друга видят и две машины друг друга видят но между собой они ээ ну они не знают ээ о своём существовании

вот

да в этом случае может получиться что в реплика сете будет две праймари и это как бы не прикольно

и в таком случае ну вообще принцип такой что в случае деления сети аээ выбирают се выбирают праймари только в том ээ в том участке сети где больше больше живых машин

соответственно например если у нас осталось три и две машины то реплика праймари нода поднимется аа в том куске где у нас три машины

а две там где две машины они даже не будут пытаться ничего делать

но смотрите если в реплика сете например ээ было

так правило такое вот

если у нас э все машины знают сколько машин в данном реплика сете

соответственно если в в этом куске сети остаётся меньше половины машин то там ничё не должно происходить

там не должно быть голосо

и соответственно так как у нас ээ голосование ну праймари сет праймари нода выбирается большинством голосов а что делать если у нас чётное количество машин в реплика сете и они всегда могут голосовать ээ поровну

например выбирать ээ две машины проголосовало за одну машину две бы машины проголосовало за другую машину и они у нас по идее равнозначны

вот

ээ соответственно у нас опять-таки праймари нода не заведётся

для такого случая добавляют специального арбитра

этот арбитр он ээ в себе внутри не хранит данные вообще

он участвует только в голосовании

вот

и это полу так как он не хранит данных это аа легковесная тачка но в рекомендациях пишется что это действительно должна быть отдельная тачка для того чтобы опять-таки увеличить релайбилити системы

вот

это хороший вопрос

поэтому она в принципе и рассчитана не для того чтобы увеличить ээ ну чтобы работать хорошо при ээ партиционировании сети а просто если вы хотите в реплика сет запихнуть э чётное количество машин то давайте вы ещё и арбитра туда з запихнёте

как раз арбитр он создан для того чтобы немного подешевле всё это стало

